<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ²™ç›’åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .log {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #e8f5e9;
            border-radius: 3px;
        }
        .error {
            background: #ffebee;
            color: #c62828;
        }
    </style>
</head>
<body>
    <h1>Chrome æ‰©å±•æ²™ç›’åŠŸèƒ½æµ‹è¯•</h1>

    <div class="test-section">
        <h2>1. æµ‹è¯•å­—ä½“æ–‡ä»¶ä¸Šä¼ </h2>
        <input type="file" id="fontFile" accept=".ttf,.otf,.woff,.woff2">
        <div id="fontInfo"></div>
    </div>

    <div class="test-section">
        <h2>2. æµ‹è¯•å­—ç¬¦è¾“å…¥</h2>
        <textarea id="characters" rows="3" placeholder="è¾“å…¥éœ€è¦ä¿ç•™çš„å­—ç¬¦...">Hello World ä½ å¥½ä¸–ç•Œ</textarea>
    </div>

    <div class="test-section">
        <h2>3. æµ‹è¯•å­—ä½“å­é›†åŒ–</h2>
        <button onclick="testSandboxSubset()">æµ‹è¯•æ²™ç›’å­é›†åŒ–</button>
        <button onclick="testDirectSubset()">æµ‹è¯•ç›´æ¥å­é›†åŒ–</button>
        <div id="result"></div>
    </div>

    <div class="test-section">
        <h2>4. æ—¥å¿—è¾“å‡º</h2>
        <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        <div id="log" class="log"></div>
    </div>

    <script type="module">
        // å¯¼å…¥å¿…è¦çš„åº“
        import opentype from 'opentype.js';
        import { compress, decompress } from 'woff2-encoder';

        let fontData = null;
        let logElement = document.getElementById('log');

        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const time = new Date().toLocaleTimeString();
            logElement.textContent += `[${time}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            logElement.textContent = '';
        }

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        document.getElementById('fontFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const arrayBuffer = await file.arrayBuffer();
                fontData = arrayBuffer;

                // æ£€æµ‹å­—ä½“æ ¼å¼
                const view = new DataView(arrayBuffer);
                let format = 'TTF';

                // è¯»å–å‰4ä¸ªå­—èŠ‚
                if (arrayBuffer.byteLength >= 4) {
                    const signature = view.getUint32(0, false);
                    if (signature === 0x774F4632) format = 'WOFF2';
                    else if (signature === 0x774F4600) format = 'WOFF';
                    else if (signature === 0x4F54544F) format = 'OTF';
                }

                document.getElementById('fontInfo').innerHTML = `
                    <div><strong>æ–‡ä»¶å:</strong> ${file.name}</div>
                    <div><strong>å¤§å°:</strong> ${(file.size / 1024).toFixed(2)} KB</div>
                    <div><strong>æ ¼å¼:</strong> ${format}</div>
                `;

                log(`âœ… å­—ä½“æ–‡ä»¶åŠ è½½æˆåŠŸ: ${file.name} (${format})`);
            } catch (error) {
                log(`âŒ åŠ è½½å­—ä½“æ–‡ä»¶å¤±è´¥: ${error.message}`);
            }
        });

        // æµ‹è¯•æ²™ç›’å­é›†åŒ–
        window.testSandboxSubset = async function() {
            if (!fontData) {
                alert('è¯·å…ˆä¸Šä¼ å­—ä½“æ–‡ä»¶');
                return;
            }

            const characters = document.getElementById('characters').value;
            if (!characters) {
                alert('è¯·è¾“å…¥éœ€è¦ä¿ç•™çš„å­—ç¬¦');
                return;
            }

            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div>æ­£åœ¨å¤„ç†...</div>';

            try {
                log('ğŸš€ å¼€å§‹æµ‹è¯•æ²™ç›’å­é›†åŒ–...');

                // åˆ›å»º iframe æ²™ç›’
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = 'sandbox.html';
                document.body.appendChild(iframe);

                // ç­‰å¾…æ²™ç›’åŠ è½½
                await new Promise((resolve, reject) => {
                    iframe.onload = resolve;
                    iframe.onerror = reject;
                    setTimeout(reject, 5000); // 5ç§’è¶…æ—¶
                });

                log('âœ… æ²™ç›’åŠ è½½æˆåŠŸ');

                // æ³¨å…¥åº“åˆ°æ²™ç›’
                iframe.contentWindow.opentype = opentype;
                iframe.contentWindow.woff2Encoder = { compress, decompress };

                log('âœ… åº“å·²æ³¨å…¥æ²™ç›’');

                // è°ƒç”¨æ²™ç›’å­é›†åŒ–å‡½æ•°
                const result = await iframe.contentWindow.sandboxCreateSubset(
                    fontData,
                    characters,
                    'woff2'
                );

                log(`âœ… æ²™ç›’å­é›†åŒ–æˆåŠŸ!`);
                log(`   åŸå§‹å¤§å°: ${result.originalSize} bytes`);
                log(`   å­é›†å¤§å°: ${result.subsetSize} bytes`);
                log(`   å‹ç¼©ç‡: ${result.compressionRate}%`);
                log(`   å®é™…æ ¼å¼: ${result.actualFormat}`);

                // æ˜¾ç¤ºç»“æœ
                const blob = new Blob([result.data], { type: 'font/woff2' });
                const url = URL.createObjectURL(blob);

                resultDiv.innerHTML = `
                    <div class="result">
                        <h3>âœ… æ²™ç›’å­é›†åŒ–æˆåŠŸ!</h3>
                        <p><strong>åŸå§‹å¤§å°:</strong> ${formatFileSize(result.originalSize)}</p>
                        <p><strong>å­é›†å¤§å°:</strong> ${formatFileSize(result.subsetSize)}</p>
                        <p><strong>å‹ç¼©ç‡:</strong> ${result.compressionRate}%</p>
                        <p><strong>å­—ç¬¦æ•°é‡:</strong> ${result.characterCount}</p>
                        <p><strong>è¾“å‡ºæ ¼å¼:</strong> ${result.actualFormat}</p>
                        <a href="${url}" download="subset.woff2">ä¸‹è½½å­é›†å­—ä½“</a>
                    </div>
                `;

                // æ¸…ç†
                setTimeout(() => {
                    document.body.removeChild(iframe);
                    URL.revokeObjectURL(url);
                }, 1000);

            } catch (error) {
                log(`âŒ æ²™ç›’å­é›†åŒ–å¤±è´¥: ${error.message}`);
                resultDiv.innerHTML = `<div class="result error">âŒ é”™è¯¯: ${error.message}</div>`;
            }
        };

        // æµ‹è¯•ç›´æ¥å­é›†åŒ–
        window.testDirectSubset = async function() {
            if (!fontData) {
                alert('è¯·å…ˆä¸Šä¼ å­—ä½“æ–‡ä»¶');
                return;
            }

            const characters = document.getElementById('characters').value;
            if (!characters) {
                alert('è¯·è¾“å…¥éœ€è¦ä¿ç•™çš„å­—ç¬¦');
                return;
            }

            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div>æ­£åœ¨å¤„ç†...</div>';

            try {
                log('ğŸš€ å¼€å§‹æµ‹è¯•ç›´æ¥å­é›†åŒ–...');

                // è§£æå­—ä½“
                let fontBuffer = fontData;

                // æ£€æµ‹å¹¶è§£å‹ WOFF2
                const view = new DataView(fontData);
                if (view.getUint32(0, false) === 0x774F4632) {
                    log('æ£€æµ‹åˆ° WOFF2 æ ¼å¼ï¼Œæ­£åœ¨è§£å‹...');
                    fontBuffer = await decompress(fontData);
                }

                // ä½¿ç”¨ opentype.js è§£æ
                const font = opentype.parse(fontBuffer);
                log(`âœ… å­—ä½“è§£ææˆåŠŸ: ${font.names.fontFamily?.en || 'Unknown'}`);

                // å¤„ç†å­—ç¬¦
                const uniqueChars = [...new Set(characters)];
                const glyphIndices = new Set();
                glyphIndices.add(0); // .notdef glyph

                for (const char of uniqueChars) {
                    const glyph = font.charToGlyph(char);
                    if (glyph && glyph.index !== undefined && glyph.index !== 0) {
                        glyphIndices.add(glyph.index);
                    }
                }

                log(`å¤„ç†äº† ${uniqueChars.length} ä¸ªå­—ç¬¦ï¼Œå¯¹åº” ${glyphIndices.size} ä¸ªå­—å½¢`);

                // åˆ›å»ºå­é›†ï¼ˆç®€åŒ–ç‰ˆï¼‰
                const subsetBuffer = fontBuffer; // è¿™é‡Œåº”è¯¥å®ç°å®é™…çš„å­é›†åŒ–é€»è¾‘

                // å‹ç¼©ä¸º WOFF2
                log('æ­£åœ¨å‹ç¼©ä¸º WOFF2 æ ¼å¼...');
                const woff2Buffer = await compress(subsetBuffer);

                log(`âœ… ç›´æ¥å­é›†åŒ–æˆåŠŸ!`);

                // æ˜¾ç¤ºç»“æœ
                const blob = new Blob([woff2Buffer], { type: 'font/woff2' });
                const url = URL.createObjectURL(blob);

                resultDiv.innerHTML = `
                    <div class="result">
                        <h3>âœ… ç›´æ¥å­é›†åŒ–æˆåŠŸ!</h3>
                        <p><strong>åŸå§‹å¤§å°:</strong> ${formatFileSize(fontData.byteLength)}</p>
                        <p><strong>å­é›†å¤§å°:</strong> ${formatFileSize(woff2Buffer.byteLength)}</p>
                        <p><strong>å‹ç¼©ç‡:</strong> ${((1 - woff2Buffer.byteLength / fontData.byteLength) * 100).toFixed(2)}%</p>
                        <p><strong>å­—ç¬¦æ•°é‡:</strong> ${uniqueChars.length}</p>
                        <a href="${url}" download="subset.woff2">ä¸‹è½½å­é›†å­—ä½“</a>
                    </div>
                `;

                URL.revokeObjectURL(url);

            } catch (error) {
                log(`âŒ ç›´æ¥å­é›†åŒ–å¤±è´¥: ${error.message}`);
                resultDiv.innerHTML = `<div class="result error">âŒ é”™è¯¯: ${error.message}</div>`;
            }
        };

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        log('ğŸ“‹ æµ‹è¯•é¡µé¢å·²åŠ è½½');
    </script>
</body>
</html>